{% extends 'base.html' %}
{% load static %}

{% block title %}  Ma Ville- {{ ville.nom }}{% endblock %}

{% block navbar %}
    <nav class="navbar fixed-top navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{% url 'dashboard' %}">
                {% include 'fragments/logo.html' %} Rising<span class="fw-light">Town</span>
            </a>
            
            <div class="d-flex align-items-center gap-3">
                
                <a href="{% url 'dashboard' %}?mode=citoyen" class="btn btn-sm btn-white border shadow-sm rounded-pill px-3 fw-bold text-primary">
                    <i class="fas fa-user-circle me-2"></i> Ma Vie
                </a>

                <div class="d-none d-md-block text-end">
                    <div class="small fw-bold text-dark">{{ user.username }}</div>
                    <div class="small text-muted" style="font-size: 0.75rem;">
                        {% if user.is_superuser %}Maire{% else %}Adjoint{% endif %}
                    </div>
                </div>
                
                <div class="bg-light rounded-circle p-2 text-primary border">
                    <i class="fas fa-user-shield"></i>
                </div>
                
                {% include 'fragments/theme_btn.html' %}

                <form action="{% url 'logout' %}" method="post" class="ms-2 logout-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                        <i class="fas fa-power-off"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container mb-5">
    
    {% if evenement %}
        <div class="container mt-4 px-0">
            <div class="alert alert-{{ evenement.type }} shadow-sm border-0 rounded-3 d-flex align-items-center" role="alert">
                <div class="fs-2 me-3 opacity-50"><i class="fas {{ evenement.icone }}"></i></div>
                <div>
                    <h5 class="alert-heading fw-bold mb-1">{{ evenement.titre }}</h5>
                    <p class="mb-0 small">{{ evenement.message|safe }}</p>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        </div>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm mt-3 border-0">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="text-center py-5">
        <span class="badge bg-white text-dark border shadow-sm rounded-pill mb-3 px-3 py-2 fw-normal">
            <i class="far fa-clock text-primary me-1"></i> <span id="live-clock">--:--</span>
        </span>
        
        <div class="d-flex align-items-center justify-content-center gap-3 mb-2">
            <h1 class="display-5 fw-bold mb-0">Ville de <span class="text-primary">{{ ville.nom }}</span></h1>
            
            <button onclick="scrollToMap()" class="btn btn-white text-primary border shadow-sm rounded-circle d-flex align-items-center justify-content-center" 
                    style="width: 50px; height: 50px; transition: transform 0.2s;" 
                    onmouseover="this.style.transform='scale(1.1)'" 
                    onmouseout="this.style.transform='scale(1)'"
                    title="Voir la carte">
                <i class="fas fa-map-marked-alt fs-5"></i>
            </button>
        </div>

        <p class="text-muted">Tableau de bord de gestion urbaine en temps r√©el</p>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="stat-tile stat-budget">
                <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                <div class="stat-content">
                    <h2>{{ ville.budget|floatformat:0 }} <small class="fs-6 text-muted">‚Ç¨</small></h2>
                    <p>Tr√©sorerie</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-tile stat-energy">
                <div class="stat-icon"><i class="fas fa-bolt"></i></div>
                <div class="stat-content">
                    <h2>{{ ville.energie_stock }} <small class="fs-6 text-muted">kWh</small></h2>
                    <p>Stock √ânergie</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-tile stat-pop">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <h2>{{ ville.population_totale }}</h2>
                    <p>Habitants</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-chart-pie me-2 text-primary"></i> Indicateurs Sociaux</span>
                
                {% if taux_chomage > 20 or sdf > 0 or sante_moyenne < 50 %}
                    <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3 border border-danger border-opacity-25">
                        <i class="fas fa-exclamation-triangle me-1"></i> Critique
                    </span>
                {% else %}
                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 border border-success border-opacity-25">
                        <i class="fas fa-check-circle me-1"></i> Stable
                    </span>
                {% endif %}
            </div>

            <div class="card-body">
                <div class="row text-center mb-2">
                    
                    <div class="col-md-3 border-end"> <h6 class="text-uppercase text-muted small fw-bold tracking-wide">Ch√¥mage</h6>
                        <div class="display-6 fw-bold my-2 {% if taux_chomage > 20 %}text-danger{% endif %}">
                            {{ taux_chomage }}%
                        </div>
                        <span class="text-muted small">{{ chomeurs }} demandeurs</span>
                    </div>

                    <div class="col-md-3 border-end">
                        <h6 class="text-uppercase text-muted small fw-bold tracking-wide">Mal-logement</h6>
                        <div class="display-6 fw-bold my-2 {% if sdf > 0 %}text-danger{% endif %}">
                            {{ sdf }}
                        </div>
                        <span class="text-muted small">Sans abri fixe</span>
                    </div>

                    <div class="col-md-3 border-end">
                        <h6 class="text-uppercase text-muted small fw-bold tracking-wide">Sant√© Publique</h6>
                        <div class="display-6 fw-bold my-2 {% if sante_moyenne < 50 %}text-danger{% else %}text-success{% endif %}">
                            {{ sante_moyenne }}%
                        </div>
                        <span class="text-muted small">Indice vital</span>
                    </div>

                    <div class="col-md-3">
                        <h6 class="text-uppercase text-muted small fw-bold tracking-wide">Humeur</h6>
                        <div class="display-6 fw-bold my-2 
                            {% if bonheur_moyen > 80 %}text-success
                            {% elif bonheur_moyen > 50 %}text-warning
                            {% else %}text-danger{% endif %}">
                            {{ bonheur_moyen }}%
                        </div>
                        <span class="text-muted small">
                            {% if bonheur_moyen > 80 %}ü§© Radieuse
                            {% elif bonheur_moyen > 50 %}üòê Correcte
                            {% else %}üò° Tendue{% endif %}
                        </span>
                    </div>

                </div>

                {% if taux_chomage > 20 or sdf > 0 or sante_moyenne < 50 or bonheur_moyen < 40 %}
                    <hr class="my-4 opacity-10">
                    
                    <div class="alert alert-light border-start border-4 border-warning shadow-sm rounded-3 d-flex" role="alert">
                        <div class="me-3 text-warning fs-3">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading fw-bold text-dark mb-1">Rapport du Conseiller</h6>
                            <ul class="mb-0 small text-muted ps-3 mt-2">
                                
                                {% if taux_chomage > 20 %}
                                    <li class="mb-1"><strong class="text-danger">Ch√¥mage :</strong> Construisez des entreprises (Usines, Commerces).</li>
                                {% endif %}

                                {% if sdf > 0 %}
                                    <li class="mb-1"><strong class="text-danger">SDF :</strong> Construisez des logements (Maisons, Immeubles).</li>
                                {% endif %}

                                {% if sante_moyenne < 50 %}
                                    <li class="mb-1"><strong class="text-danger">Sant√© :</strong> L'H√¥pital manque de moyens ou de personnel.</li>
                                {% endif %}

                                {% if bonheur_moyen < 40 %}
                                    <li class="mb-1"><strong class="text-danger">Col√®re Grondante :</strong> Organisez des f√™tes (√âcole) ou baissez les imp√¥ts !</li>
                                {% endif %}

                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h3 class="h4 fw-bold m-0">üèóÔ∏è Actions Rapides</h3>
            </div>
            
            {% if user.is_superuser %}
                <div class="d-flex flex-wrap gap-3 align-items-center mt-2">
                    <a href="{% url 'construire' %}" class="btn-soft btn-build text-decoration-none">
                        <i class="fas fa-hammer"></i> Construire
                    </a>
                    
                    <form action="{% url 'verser_salaires' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn-soft btn-pay" onclick="return confirm('Verser les salaires et avancer le temps ?');">
                            <i class="fas fa-forward"></i> Avancer le temps
                        </button>
                    </form>
                    
                    <form action="{% url 'collecter_impots' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn-soft btn-tax" onclick="return confirm('Pr√©lever 10% sur tous les citoyens ?');">
                            <i class="fas fa-hand-holding-usd"></i> Imp√¥ts
                        </button>
                    </form>

                    <div class="vr mx-2 opacity-25"></div>

                    <a href="{% url 'gestion_citoyens' %}" class="btn btn-light border shadow-sm rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;" title="Citoyens">
                        <i class="fas fa-users-cog text-muted"></i>
                    </a>
                    <a href="{% url 'parametres_ville' %}" class="btn btn-light border shadow-sm rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;" title="Param√®tres">
                        <i class="fas fa-cogs text-muted"></i>
                    </a>
                </div>
            {% else %}
                <div class="alert alert-info border-0 shadow-sm">
                    <i class="fas fa-info-circle me-2"></i> Mode lecture (Adjoint).
                </div>
            {% endif %}
        </div>
    </div>

    <div class="mb-5 position-relative">
        <div class="d-flex justify-content-between align-items-end mb-3">
            <h3 class="h4 fw-bold m-0">üó∫Ô∏è Carte de la Ville</h3>
            
            <div class="d-flex align-items-center bg-white p-2 rounded-pill shadow-sm border gap-2">
                <button class="btn btn-sm btn-light rounded-circle" onclick="recenterMap()" title="Recentrer">
                    <i class="fas fa-crosshairs text-primary"></i>
                </button>
                <div class="vr opacity-25"></div>
                <i class="fas fa-search-minus text-muted zoom-btn ms-2" onclick="manualZoom(-1)"></i>
                <input type="range" class="form-range mx-2" min="0.2" max="1.5" step="0.1" value="0.5" id="zoomSlider" style="width: 100px;">
                <i class="fas fa-search-plus text-muted zoom-btn me-2" onclick="manualZoom(1)"></i>
            </div>
        </div>
        
        {% if moving_batiment %}
            <div class="alert alert-primary d-flex justify-content-between align-items-center shadow border-0 rounded-3 mb-3">
                <div>
                    <strong><i class="fas fa-arrows-alt"></i> Mode D√©placement</strong> : {{ moving_batiment.nom }}
                    <div class="small">Cliquez sur un emplacement blanc clignotant.</div>
                </div>
                <a href="{% url 'dashboard' %}" class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3">Annuler</a>
            </div>
        {% endif %}
        
        <div class="card border-0 shadow-lg overflow-hidden">
            <div class="card-body p-0 position-relative" id="city-viewport">
                <div class="iso-scene {% if moving_batiment %}locked-mode{% endif %}" id="cityScene">
                    <div id="the-sun" class="celestial-body sun"></div>
                    <div id="the-moon" class="celestial-body moon"></div>
                    
                    <div class="iso-map">
                        <div class="iso-grid"></div>

                        {% if moving_batiment %}
                            <div class="iso-ghost" 
                                data-move-url="{% url 'valider_deplacement' moving_batiment.id 999 888 %}"
                                style="
                                    width: calc((var(--cell-size) * {{ moving_batiment.largeur }}) - 2px);
                                    height: calc((var(--cell-size) * {{ moving_batiment.hauteur }}) - 2px);
                                ">
                            </div>
                        {% endif %}

                        {% load static %} 
                        {% for bat in ville.batiments.all %}
                            
                            <a href="{% url 'batiment_detail' bat.id %}" 
                               class="iso-building building-link" 
                               data-bat-name="{{ bat.nom }}"
                               style="
                                   left: calc(var(--cell-size) * {{ bat.x }}); 
                                   top: calc(var(--cell-size) * {{ bat.y }});
                                   width: calc((var(--cell-size) * {{ bat.largeur }}) - 1px); 
                                   height: calc((var(--cell-size) * {{ bat.hauteur }}) - 1px);
                                   z-index: {{ bat.y|add:bat.hauteur|add:10 }};
                               ">
                                
                                <img src="{% static 'img/'|add:bat.type_batiment|lower|add:'.png' %}" 
                                     alt="{{ bat.type_batiment }}"
                                     class="building-sprite"
                                     style="{% if bat == moving_batiment %}opacity: 0.6; filter: grayscale(100%) brightness(1.2);{% endif %}"
                                     onerror="this.src='https://via.placeholder.com/150?text=IMG'">
                                     
                                <div class="bat-name">{{ bat.nom|truncatechars:15 }}</div>
                            </a>

                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center bg-white">
            <span><i class="fas fa-newspaper me-2 text-primary"></i> Journal Officiel</span>
            {% if user.is_superuser or user.is_adjoint %}
                <button class="btn btn-sm btn-light border rounded-circle" type="button" data-bs-toggle="collapse" data-bs-target="#formNews">
                    <i class="fas fa-plus"></i>
                </button>
            {% endif %}
        </div>
        
        <div class="collapse p-3 bg-light border-bottom" id="formNews">
            <form action="{% url 'publier_news_ville' %}" method="post" class="d-flex gap-2">
                {% csrf_token %}
                <input type="text" name="titre" class="form-control form-control-sm" placeholder="Titre" required>
                <input type="text" name="contenu" class="form-control form-control-sm" placeholder="Message..." required>
                <button type="submit" class="btn btn-primary btn-sm px-3">Publier</button>
            </form>
        </div>

        <div class="card-body">
            {% for actu in ville.actualites.all reversed %}
                {% if not actu.batiment %}
                    <div class="journal-item mb-4">
                        <div class="journal-date">{{ actu.date_creation|date:"d M Y - H:i" }}</div>
                        <div class="journal-title">{{ actu.titre }}</div>
                        <p class="text-muted mb-0 small">{{ actu.contenu }}</p>
                        {% if user.is_superuser %}
                            <a href="{% url 'supprimer_actualite' actu.id %}" class="text-danger small text-decoration-none mt-1 d-inline-block hover-underline">
                                Supprimer
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            {% empty %}
                <div class="text-center py-5 text-muted opacity-50">
                    <i class="far fa-newspaper fs-1 mb-2"></i><br>
                    Aucune actualit√© r√©cente.
                </div>
            {% endfor %}
        </div>
    </div>
</div>





{% endblock %}

{% block extra_js %}
<script>
    
    // --- VARIABLES GLOBALES ---
    const scene = document.querySelector('.iso-scene');
    let isDown = false;
    let startX, startY, scrollLeft, scrollTop;

    // --- INITIALISATION ---
    document.addEventListener("DOMContentLoaded", function() {
        initGridSystem();
        
        // Centre la carte apr√®s un court d√©lai pour laisser le temps au rendu
        setTimeout(recenterMap, 100);
    });

    // 1. SYST√àME DE GRILLE (PLACEMENT)
    function initGridSystem() {
        const gridContainer = document.querySelector('.iso-grid');
        const mapWidth = parseInt("{{ ville.largeur_map }}") || 10; 
        const mapHeight = parseInt("{{ ville.hauteur_map }}") || 10;
        
        if (gridContainer) {
            gridContainer.innerHTML = ''; // Reset
            
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    // Positionnement CSS (les variables calculeront les pixels)
                    cell.style.left = `calc(var(--cell-size) * ${x})`;
                    cell.style.top = `calc(var(--cell-size) * ${y})`;
                    
                    // Stockage des coordonn√©es
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // √âV√âNEMENT : Survol (Bouge le fant√¥me)
                    cell.addEventListener('mouseenter', (e) => {
                        updateGhostPosition(x, y);
                    });
                    
                    // CLIC : Validation du d√©placement
                    cell.addEventListener('click', (e) => {
                        handleGridClick(x, y);
                    });

                    gridContainer.appendChild(cell);
                }
            }
        }

        // Mode D√©placement Actif ?
        const movingBatimentId = "{{ moving_batiment.id|default:'' }}";
        if (movingBatimentId) {
            if(scene) scene.classList.add('moving-mode');
            const ghost = document.querySelector('.iso-ghost');
            if(ghost) ghost.classList.add('active');
        }
    }

    function updateGhostPosition(x, y) {
        const ghost = document.querySelector('.iso-ghost');
        if (!ghost) return;

        ghost.style.left = `calc(var(--cell-size) * ${x})`;
        ghost.style.top = `calc(var(--cell-size) * ${y})`;
        
        ghost.dataset.currentX = x;
        ghost.dataset.currentY = y;
    }

    function handleGridClick(x, y) {
        const ghost = document.querySelector('.iso-ghost');
        if (ghost && ghost.dataset.moveUrl) {
            const baseUrl = ghost.dataset.moveUrl;
            // Remplace les placeholders par les vraies coordonn√©es
            const finalUrl = baseUrl.replace('/999/', `/${x}/`).replace('/888/', `/${y}/`);
            window.location.href = finalUrl;
        }
    }

    // 2. SCROLL & DRAG (NAVIGATION CARTE)
    function recenterMap() {
        if(scene) {
            scene.scrollTop = (scene.scrollHeight - scene.clientHeight) / 2;
            scene.scrollLeft = (scene.scrollWidth - scene.clientWidth) / 2;
        }
    }

    if(scene) {
        scene.addEventListener('mousedown', (e) => {
            isDown = true;
            scene.style.cursor = 'grabbing';
            startX = e.pageX - scene.offsetLeft;
            startY = e.pageY - scene.offsetTop;
            scrollLeft = scene.scrollLeft;
            scrollTop = scene.scrollTop;
        });
        scene.addEventListener('mouseleave', () => { isDown = false; scene.style.cursor = 'grab'; });
        scene.addEventListener('mouseup', () => { isDown = false; scene.style.cursor = 'grab'; });
        scene.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - scene.offsetLeft;
            const y = e.pageY - scene.offsetTop;
            const walkX = (x - startX) * 1.5; 
            const walkY = (y - startY) * 1.5;
            scene.scrollLeft = scrollLeft - walkX;
            scene.scrollTop = scrollTop - walkY;
        });
    }

    // 3. ZOOM
    const slider = document.getElementById('zoomSlider');
    const root = document.documentElement;
    
    function updateZoom() {
        if(!slider) return;
        const newSize = 60 * slider.value; 
        root.style.setProperty('--cell-size', newSize + 'px');
    }
    if(slider) {
        slider.addEventListener('input', updateZoom);
        updateZoom(); // Init
    }

    function manualZoom(direction) {
        if (!slider) return;
        if (direction > 0) slider.stepUp();
        else slider.stepDown();
        updateZoom();
    }

    // 4. M√âT√âO & TEMPS
    function updateEnvironment() {
        const now = new Date();
        const hour = now.getHours();
        const decimalHour = hour + (now.getMinutes() / 60);

        const options = { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const timeString = now.toLocaleDateString('fr-FR', options);
        const clockEl = document.getElementById('live-clock');
        if(clockEl) clockEl.innerText = timeString.charAt(0).toUpperCase() + timeString.slice(1);

        const viewport = document.getElementById('city-viewport');
        
        if(viewport && scene) {
            scene.classList.remove('sky-night', 'sky-dawn', 'sky-day', 'sky-dusk');
            viewport.classList.remove('sky-night');

            if (hour >= 6 && hour < 9) scene.classList.add('sky-dawn');
            else if (hour >= 9 && hour < 18) scene.classList.add('sky-day');
            else if (hour >= 18 && hour < 21) scene.classList.add('sky-dusk');
            else {
                scene.classList.add('sky-night');
                viewport.classList.add('sky-night');
            }
        }

        const sun = document.getElementById('the-sun');
        const moon = document.getElementById('the-moon');

        if (decimalHour >= 6 && decimalHour <= 20) {
            // JOUR
            const percentDay = (decimalHour - 6) / 14; 
            const posX = 10 + (percentDay * 80);
            const posY = 120 - (Math.sin(percentDay * Math.PI) * 100);
            
            if(sun) { sun.style.left = posX + '%'; sun.style.top = posY + '%'; sun.style.opacity = '1'; }
            if(moon) { moon.style.top = '150%'; moon.style.opacity = '0'; }
        } else {
            // NUIT
            let percentNight = (decimalHour > 20) ? (decimalHour - 20) / 10 : (decimalHour + 4) / 10;
            const posX = 10 + (percentNight * 80);
            const posY = 100 - (Math.sin(percentNight * Math.PI) * 80);

            if(moon) { moon.style.left = posX + '%'; moon.style.top = posY + '%'; moon.style.opacity = '1'; }
            if(sun) { sun.style.top = '150%'; sun.style.opacity = '0'; }
        }
    }
    
    // Lance la m√©t√©o imm√©diatement et met √† jour toutes les secondes
    updateEnvironment();
    setInterval(updateEnvironment, 1000);

    // 5. GESTION ACC√àS RESTREINTS (PRISON)
    function initRestrictedAccess() {
        const restrictedBuildings = document.querySelectorAll('.restricted-access');
        
        restrictedBuildings.forEach(building => {
            building.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const tooltip = this.querySelector('.map-error-tooltip');
                const sprite = this.querySelector('.building-sprite');

                if (tooltip) {
                    tooltip.classList.add('visible');
                    
                    // Animation Shake
                    if(sprite) {
                        sprite.style.transform = "translateX(-50%) rotateZ(45deg) rotateX(-60deg) scale(1.6) translateX(-5px)"; 
                        setTimeout(() => { sprite.style.transform = ""; }, 200);
                    }

                    setTimeout(() => {
                        tooltip.classList.remove('visible');
                    }, 2000);
                }
            });
        });
    }

    // 2. D√âTECTION DU MODE D√âPLACEMENT
        const movingBatimentId = "{{ moving_batiment.id|default:'' }}";
        if (movingBatimentId) {
            if(scene) scene.classList.add('moving-mode');
            const ghost = document.querySelector('.iso-ghost');
            if(ghost) ghost.classList.add('active');

            // --- AJOUT : SCROLL AUTOMATIQUE VERS LA CARTE ---
            const viewport = document.getElementById('city-viewport');
            if(viewport) {
                // On attend un tout petit peu que le rendu soit fini
                setTimeout(() => {
                    viewport.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300); // D√©lai court pour laisser le temps au navigateur de charger
            }
            // -----------------------------------------------
        }
        // FONCTION DE NAVIGATION FLUIDE
    function scrollToMap() {
        const viewport = document.getElementById('city-viewport');
        if(viewport) {
            viewport.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Petit effet visuel bonus : Highlight de la carte
            viewport.classList.add('shadow-lg');
            setTimeout(() => viewport.classList.remove('shadow-lg'), 1000);
        }
    }

</script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --map-width: {{ ville.largeur_map }};  
        --map-height: {{ ville.hauteur_map }}; 
    }
</style>
{% endblock %}